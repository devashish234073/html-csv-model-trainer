<!DOCTYPE html>
<html>
<head>
  <title>CSV File Upload and Training Example</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.7.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <style>
    table{
      border-collapse: collapse;
    }
    table td {
      border: 1px solid black;
      padding:5px 10px;
    }
    select{
      width:100%;
    }
    .afterUpload{
      display: none;
    }
  </style>
</head>
<body>
  <table>
    <tr><td colspan="2"><h1>CSV File Upload and Training</h1></td></tr>
    <tr><td><input type="file" id="fileInput"></td><td><button onclick="uploadFile()">Upload</button></td></tr>
    <tr class="afterUpload"><td><label for="inputColumn">Input Column:</label></td><td><select id="inputColumn" onchange="selectColInput()"></select></td></tr>
    <tr class="afterUpload"><td><label for="outputColumn">Output Column:</label></td><td><select id="outputColumn" onchange="selectColOutput()"></select></td></tr>
    <tr class="afterUpload"><td id="output"></td><td><button onclick="trainModel()">Train Model</button></td></tr>
  </table>
  <br>

  <table id="dataTable"></table>

  <script>
    // Function to read the file content
    function readFileContent(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();

        reader.onload = (event) => {
          resolve(event.target.result);
        };

        reader.onerror = (event) => {
          reject(event.target.error);
        };

        reader.readAsText(file);
      });
    }

    // Function to display the column names in the select elements
    function displayColumns(data) {
      const columnNames = Object.keys(data[0]);

      columnNames.forEach((column) => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        inputColumnSelect.appendChild(option);

        const outputOption = document.createElement('option');
        outputOption.value = column;
        outputOption.textContent = column;
        outputColumnSelect.appendChild(outputOption);
      });
    }

    let antiColor = {"yellow":"pink","pink":"yellow"};

    function selectColInput() {
      selectCol(inputColumnSelect.value,"yellow");
    }
    function selectColOutput() {
      selectCol(outputColumnSelect.value,"pink");
    }

    function selectCol(col,color) {
      let cols = document.querySelectorAll(".col_");
      let id = "col_"+col;
      for(let i in cols) {
        if(cols[i].getAttribute("id")==id){
          cols[i].style.backgroundColor = color;
        } else {
          if(cols[i].style.backgroundColor!=antiColor[color]) {
            cols[i].style.backgroundColor = "white";
          }
        }
      }
    }

    let dataTable = document.querySelector("#dataTable");
    let output = document.querySelector("#output");

    let fileData;
    const inputColumnSelect = document.getElementById('inputColumn');
    const outputColumnSelect = document.getElementById('outputColumn');

    async function uploadFile() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      const fileContent = await readFileContent(file);
      console.log(fileContent);
      fileData = $.csv.toObjects(fileContent);
      let cols = [];
      fileData.forEach((row) => {
        let tr = document.createElement("tr");
        console.log("ROW created..");
        Object.keys(row).forEach((column) => {
          let val = row[column];
          let td = document.createElement("td");
          td.innerText = val;
          td.setAttribute("id","col_"+column);
          td.setAttribute("class","col_");
          tr.appendChild(td);
          if(cols.indexOf(column)==-1) {
            cols.push(column);
          }
        });
        dataTable.appendChild(tr);
      });
      for(let i in cols) {
        let opt1 = document.createElement("option");
        opt1.value = cols[i];
        opt1.innerText = cols[i];
        let opt2 = document.createElement("option");
        opt2.value = cols[i];
        opt2.innerText = cols[i];
        inputColumnSelect.appendChild(opt1);
        outputColumnSelect.appendChild(opt2);
      }
      let afterUploads = document.querySelectorAll(".afterUpload");
      for(let i in afterUploads) {
        afterUploads[i].style.display = "table-row";
      }
    }

    // Function to train the model
    async function trainModel() {
      try {
        const data = fileData;
        const { inputs, outputs } = convertToTensors(data, inputColumnSelect.value, outputColumnSelect.value);
        const model = tf.sequential();
        model.add(tf.layers.dense({ units: 10, inputShape: [inputs.shape[1]] }));
        model.add(tf.layers.dense({ units: outputs.shape[1] }));

        model.compile({ loss: 'meanSquaredError', optimizer: 'sgd' });
        await model.fit(inputs, outputs, { epochs: 100 });
        output.innerText = 'Model trained successfully!';
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function convertToTensors(data, inputColumn, outputColumn) {
      const inputs = [];
      const outputs = [];

      data.forEach((row) => {
        const input = [];
        const output = [];

        Object.keys(row).forEach((column) => {
          if (column == inputColumn) {
            input.push(parseFloat(row[column]));
          } else if (column == outputColumn) {
            output.push(parseFloat(row[column]));
          }
        });

        inputs.push(input);
        outputs.push(output);
      });

      return {
        inputs: tf.tensor2d(inputs),
        outputs: tf.tensor2d(outputs),
      };
    }
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>
</body>
</html>
